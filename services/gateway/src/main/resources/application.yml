server:
  port: ${SERVER_PORT:8080}
  shutdown: graceful

spring:
  application:
    name: gateway
  lifecycle:
    timeout-per-shutdown-phase: 30s

  # === Spring Cloud Gateway ===
  cloud:
    gateway:
      # Маршруты к downstream сервисам
      routes:
        # User Service - аутентификация
        - id: user-service-auth
          uri: ${USER_SERVICE_URL:http://localhost:8081}
          predicates:
            - Path=/api/v1/auth/**

        # User Service - пользователи
        - id: user-service-users
          uri: ${USER_SERVICE_URL:http://localhost:8081}
          predicates:
            - Path=/api/v1/users/**

        # User Service - организации
        - id: user-service-organizations
          uri: ${USER_SERVICE_URL:http://localhost:8081}
          predicates:
            - Path=/api/v1/organizations/**

        # Event Service - события
        - id: event-service-events
          uri: ${EVENT_SERVICE_URL:http://localhost:8082}
          predicates:
            - Path=/api/v1/events/**

        # Event Service - регистрации
        - id: event-service-registrations
          uri: ${EVENT_SERVICE_URL:http://localhost:8082}
          predicates:
            - Path=/api/v1/registrations/**

        # Payment Service - платежи
        - id: payment-service-payments
          uri: ${PAYMENT_SERVICE_URL:http://localhost:8083}
          predicates:
            - Path=/api/v1/payments/**

        # Payment Service - webhooks
        - id: payment-service-webhooks
          uri: ${PAYMENT_SERVICE_URL:http://localhost:8083}
          predicates:
            - Path=/api/v1/webhooks/**

        # Notification Service
        - id: notification-service
          uri: ${NOTIFICATION_SERVICE_URL:http://localhost:8084}
          predicates:
            - Path=/api/v1/notifications/**

        # Media Service
        - id: media-service
          uri: ${MEDIA_SERVICE_URL:http://localhost:8085}
          predicates:
            - Path=/api/v1/media/**

        # Analytics Service
        - id: analytics-service
          uri: ${ANALYTICS_SERVICE_URL:http://localhost:8086}
          predicates:
            - Path=/api/v1/analytics/**

      # Rate limiting по умолчанию
      default-filters:
        - name: RequestRateLimiter
          args:
            redis-rate-limiter:
              replenishRate: 100
              burstCapacity: 200
              requestedTokens: 1
            key-resolver: "#{@userKeyResolver}"

  # === Redis для rate limiting ===
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:aqstream-redis-secret}

# === JWT Configuration ===
jwt:
  secret: ${JWT_SECRET:development-secret-key-minimum-32-characters-long}

# === CORS Configuration ===
cors:
  allowed-origins: ${CORS_ALLOWED_ORIGINS:http://localhost:3000}

# === Actuator ===
management:
  endpoints:
    web:
      exposure:
        include: health,info,prometheus,gateway
  endpoint:
    health:
      show-details: always
      probes:
        enabled: true
    gateway:
      enabled: true
  health:
    redis:
      enabled: true
  info:
    build:
      enabled: true
    git:
      enabled: true
      mode: full
    java:
      enabled: true

# === Logging ===
logging:
  level:
    root: INFO
    ru.aqstream.gateway: INFO
    org.springframework.cloud.gateway: INFO
  pattern:
    console: "%d{HH:mm:ss.SSS} [%thread] [%X{correlationId}] %-5level %logger{36} - %msg%n"

# === AqStream Configuration ===
aqstream:
  environment: ${AQSTREAM_ENVIRONMENT:development}
  services:
    user-service: ${USER_SERVICE_URL:http://localhost:8081}
    event-service: ${EVENT_SERVICE_URL:http://localhost:8082}
    payment-service: ${PAYMENT_SERVICE_URL:http://localhost:8083}
    notification-service: ${NOTIFICATION_SERVICE_URL:http://localhost:8084}
    media-service: ${MEDIA_SERVICE_URL:http://localhost:8085}
    analytics-service: ${ANALYTICS_SERVICE_URL:http://localhost:8086}
