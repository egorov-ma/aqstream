name: Documentation

on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - '.github/workflows/docs.yml'
  pull_request:
    branches: [main]
    paths:
      - 'docs/**'
  workflow_dispatch:

jobs:
  validate:
    name: Validate Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate Markdown
        run: |
          cd docs && npx markdownlint-cli2 "**/*.md" \
            --config "_internal/.markdownlint-cli2.jsonc"
        continue-on-error: true

      - name: Validate OpenAPI (if specs exist)
        run: |
          if [ -d "docs/tech-stack/backend/api/specs" ] && [ -n "$(ls -A docs/tech-stack/backend/api/specs/*.yaml 2>/dev/null)" ]; then
            npx @stoplight/spectral-cli lint "docs/tech-stack/backend/api/specs/*.yaml" \
              --ruleset "docs/_internal/validators/spectral.yaml"
          else
            echo "No OpenAPI specs to validate"
          fi
        continue-on-error: true

  build:
    name: Build Documentation
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install -r docs/_internal/doc-as-code/requirements.txt

      - name: Build documentation
        run: cd docs/_internal && mkdocs build -d ../../site

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: docs-site
          path: site
          retention-days: 1

  deploy:
    name: Deploy to docs.aqstream.ru
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: docs
      url: https://docs.aqstream.ru
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: docs-site
          path: site

      - name: Debug artifact
        run: |
          echo "Contents of site/:"
          ls -la site/
          echo "Total files:"
          find site/ -type f | wc -l

      - name: Deploy via rsync
        env:
          SSH_KEY: ${{ secrets.SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          rsync -avz --delete -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            site/ ${{ vars.SSH_USER }}@${{ vars.SSH_HOST }}:/var/www/docs.aqstream.ru/
          rm ~/.ssh/deploy_key

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.SSH_HOST }}
          username: ${{ vars.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "Files deployed:"
            ls -la /var/www/docs.aqstream.ru/ | head -20
            chmod -R 755 /var/www/docs.aqstream.ru
            echo "Documentation deployed successfully"
