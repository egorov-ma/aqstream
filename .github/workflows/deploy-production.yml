name: Deploy Production

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (commit SHA or tag)'
        required: true
        type: string
      confirm:
        description: 'Type "deploy" to confirm production deployment'
        required: true
        type: string

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

jobs:
  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    steps:
      - name: Validate confirmation
        if: ${{ github.event.inputs.confirm != 'deploy' }}
        run: |
          echo "ERROR: You must type 'deploy' to confirm production deployment"
          exit 1

      - name: Validate version format
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [[ ! "$VERSION" =~ ^[a-f0-9]{7,40}$ ]] && [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "ERROR: Version must be a commit SHA or semantic version tag (e.g., v1.0.0)"
            exit 1
          fi

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: validate
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify images exist
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "Verifying images for version: $VERSION"
          # docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/gateway:$VERSION
          # docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/user-service:$VERSION
          # docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/event-service:$VERSION
        continue-on-error: true

      - name: Create deployment record
        run: |
          echo "Recording deployment..."
          echo "Version: ${{ github.event.inputs.version }}"
          echo "Deployed by: ${{ github.actor }}"
          echo "Time: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"

      - name: Deploy to Production Server
        env:
          VERSION: ${{ github.event.inputs.version }}
        run: |
          echo "Deploying version $VERSION to production..."
          # SSH deployment will be configured when production server is available
          # ssh deploy@aqstream.com "cd /app && ./deploy.sh $VERSION"

      - name: Health Check
        run: |
          echo "Checking production health..."
          # for i in {1..30}; do
          #   if curl -sf https://aqstream.com/actuator/health | grep -q "UP"; then
          #     echo "Production is healthy"
          #     exit 0
          #   fi
          #   sleep 10
          # done
          # echo "Health check failed"
          # exit 1
        continue-on-error: true

      - name: Notify on Success
        if: success()
        run: |
          echo "Production deployment successful!"
          echo "Version: ${{ github.event.inputs.version }}"
          # Slack/Email notification will be added

      - name: Notify on Failure
        if: failure()
        run: |
          echo "Production deployment FAILED!"
          echo "Version: ${{ github.event.inputs.version }}"
          echo "Manual intervention may be required"
