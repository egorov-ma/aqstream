# P2-014 –®–∞–±–ª–æ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞

## –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ

| –ü–æ–ª–µ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|------|----------|
| –§–∞–∑–∞ | Phase 2: Core |
| –°—Ç–∞—Ç—É—Å | `ready` |
| –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | `high` |
| –°–≤—è–∑—å —Å roadmap | [Roadmap - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è](../../business/roadmap.md#—Ñ–∞–∑–∞-2-core) |

## –ö–æ–Ω—Ç–µ–∫—Å—Ç

### –ë–∏–∑–Ω–µ—Å-–∫–æ–Ω—Ç–µ–∫—Å—Ç

–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∏—Ä—É—é—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –æ —Å–æ–±—ã—Ç–∏—è—Ö: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å –±–∏–ª–µ—Ç–æ–º, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, –∏–∑–º–µ–Ω–µ–Ω–∏—è. –®–∞–±–ª–æ–Ω—ã –ø–æ–∑–≤–æ–ª—è—é—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —É–ø—Ä–æ—â–∞—é—Ç –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—é.

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç

- Notification Service —Å–ª—É—à–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –∏–∑ RabbitMQ
- –®–∞–±–ª–æ–Ω—ã –Ω–∞ Mustache + Markdown
- –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Telegram Bot API
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—Ç–ø—Ä–∞–≤–æ–∫

**–°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:**
- [Notification Service](../../tech-stack/backend/services/notification-service.md)
- [Domain Model - NotificationTemplate](../../data/domain-model.md#notificationtemplate)
- [Domain Model - NotificationLog](../../data/domain-model.md#notificationlog)

## –¶–µ–ª—å

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É —à–∞–±–ª–æ–Ω–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—Ç–ø—Ä–∞–≤–∫—É –ø–æ —Å–æ–±—ã—Ç–∏—è–º –∏–∑ RabbitMQ.

## Definition of Ready (DoR)

- [x] –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–Ω—è—Ç–µ–Ω –∏ –æ–ø–∏—Å–∞–Ω
- [x] –¶–µ–ª—å —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–∞
- [x] Acceptance Criteria –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
- [x] –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω—ã
- [x] –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã
- [x] –ù–µ—Ç –±–ª–æ–∫–µ—Ä–æ–≤

## Acceptance Criteria

### –®–∞–±–ª–æ–Ω—ã

- [ ] –°–∏—Å—Ç–µ–º–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ë–î (NotificationTemplate)
- [ ] –®–∞–±–ª–æ–Ω—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç Mustache —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
- [ ] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Markdown –≤ —Ç–µ–ª–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- [ ] –°–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —à–∞–±–ª–æ–Ω–∞

### Phase 2 —à–∞–±–ª–æ–Ω—ã

- [ ] `user.welcome` ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- [ ] `registration.confirmed` ‚Äî –±–∏–ª–µ—Ç —Å QR-–∫–æ–¥–æ–º
- [ ] `registration.cancelled` ‚Äî –æ—Ç–º–µ–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- [ ] `event.reminder` ‚Äî –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ —Å–æ–±—ã—Ç–∏–∏ (–∑–∞ 24—á)
- [ ] `event.changed` ‚Äî –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã/–º–µ—Å—Ç–∞
- [ ] `event.cancelled` ‚Äî –æ—Ç–º–µ–Ω–∞ —Å–æ–±—ã—Ç–∏—è

### Event Listeners

- [ ] `UserRegisteredEvent` ‚Üí `user.welcome`
- [ ] `RegistrationCreatedEvent` ‚Üí `registration.confirmed` + –±–∏–ª–µ—Ç —Å QR
- [ ] `RegistrationCancelledEvent` ‚Üí `registration.cancelled`
- [ ] `EventChangedEvent` ‚Üí `event.changed` (–≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º)
- [ ] `EventCancelledEvent` ‚Üí `event.cancelled` (–≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º)

### –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è

- [ ] Scheduler –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
- [ ] –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ 24 —á–∞—Å–∞ –¥–æ —Å–æ–±—ã—Ç–∏—è
- [ ] –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –µ—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

- [ ] –í—Å–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ NotificationLog
- [ ] –°—Ç–∞—Ç—É—Å—ã: PENDING, SENT, FAILED
- [ ] –ü—Ä–∏ –æ—à–∏–±–∫–µ ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è error_message
- [ ] Retry –º–µ—Ö–∞–Ω–∏–∑–º –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö (3 –ø–æ–ø—ã—Ç–∫–∏)

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Ç–∫–ª—é—á–∏—Ç—å –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ —Ç–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- [ ] API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π

## Definition of Done (DoD)

- [ ] –í—Å–µ Acceptance Criteria –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
- [ ] –ö–æ–¥ –Ω–∞–ø–∏—Å–∞–Ω —Å–æ–≥–ª–∞—Å–Ω–æ code style –ø—Ä–æ–µ–∫—Ç–∞
- [ ] Unit —Ç–µ—Å—Ç—ã –¥–ª—è template rendering
- [ ] Integration —Ç–µ—Å—Ç—ã (RabbitMQ ‚Üí Notification)
- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è —à–∞–±–ª–æ–Ω–æ–≤ (seed data)
- [ ] Code review –ø—Ä–æ–π–¥–µ–Ω
- [ ] CI/CD pipeline –ø—Ä–æ—Ö–æ–¥–∏—Ç

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ó–∞—Ç—Ä–∞–≥–∏–≤–∞–µ–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

- [x] Backend: `notification-service` (–≤—Å–µ –º–æ–¥—É–ª–∏)
- [ ] Frontend: –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- [x] Database: —Ç–∞–±–ª–∏—Ü—ã `notification_templates`, `notification_logs`, `notification_preferences`
- [ ] Infrastructure: ‚Äî

### –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö

```sql
-- –®–∞–±–ª–æ–Ω—ã
CREATE TABLE notification_service.notification_templates (
    id UUID PRIMARY KEY,
    code VARCHAR(50) NOT NULL UNIQUE,
    channel VARCHAR(20) NOT NULL DEFAULT 'TELEGRAM',
    body TEXT NOT NULL, -- Mustache + Markdown
    variables JSONB NOT NULL DEFAULT '{}',
    is_system BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- –õ–æ–≥ –æ—Ç–ø—Ä–∞–≤–æ–∫
CREATE TABLE notification_service.notification_logs (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL,
    channel VARCHAR(20) NOT NULL,
    template_code VARCHAR(50),
    telegram_chat_id VARCHAR(50),
    body TEXT NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'PENDING',
    error_message TEXT,
    sent_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
CREATE TABLE notification_service.notification_preferences (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL UNIQUE,
    settings JSONB NOT NULL DEFAULT '{"event_reminder": true, "registration_updates": true}',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### –ü—Ä–∏–º–µ—Ä —à–∞–±–ª–æ–Ω–∞

```mustache
üé´ *–ë–∏–ª–µ—Ç –Ω–∞ —Å–æ–±—ã—Ç–∏–µ*

–ü—Ä–∏–≤–µ—Ç, {{firstName}}!

–í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å –Ω–∞ *{{eventTitle}}*.

üìã *–î–µ—Ç–∞–ª–∏:*
‚Ä¢ –ö–æ–¥ –±–∏–ª–µ—Ç–∞: `{{confirmationCode}}`
‚Ä¢ –¢–∏–ø: {{ticketTypeName}}
‚Ä¢ –î–∞—Ç–∞: {{eventDate}}
‚Ä¢ –ú–µ—Å—Ç–æ: {{eventLocation}}

[–ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ —Å–æ–±—ã—Ç–∏–∏]({{eventUrl}})
```

### Event Listener

```java
@Component
@RequiredArgsConstructor
public class NotificationEventListener {

    private final NotificationService notificationService;
    private final UserClient userClient;

    @RabbitListener(queues = "notifications.registration.created")
    public void handleRegistrationCreated(RegistrationCreatedEvent event) {
        UserDto user = userClient.findById(event.getUserId());

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        if (!notificationService.shouldNotify(user.getId(), "registration_updates")) {
            return;
        }

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –±–∏–ª–µ—Ç —Å QR
        byte[] ticketImage = ticketImageService.generate(event);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º
        notificationService.sendWithImage(
            SendNotificationRequest.builder()
                .userId(user.getId())
                .telegramChatId(user.getTelegramChatId())
                .templateCode("registration.confirmed")
                .variables(Map.of(
                    "firstName", event.getFirstName(),
                    "eventTitle", event.getEventTitle(),
                    "confirmationCode", event.getConfirmationCode(),
                    "ticketTypeName", event.getTicketTypeName(),
                    "eventDate", formatDate(event.getEventStartsAt()),
                    "eventLocation", event.getEventLocation(),
                    "eventUrl", generateEventUrl(event.getEventId())
                ))
                .image(ticketImage)
                .build()
        );
    }
}
```

### Reminder Scheduler

```java
@Component
@RequiredArgsConstructor
public class EventReminderScheduler {

    @Scheduled(cron = "0 0 * * * *") // –∫–∞–∂–¥—ã–π —á–∞—Å
    public void sendReminders() {
        // –ù–∞–π—Ç–∏ —Å–æ–±—ã—Ç–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ 24-25 —á–∞—Å–æ–≤
        Instant from = Instant.now().plus(24, ChronoUnit.HOURS);
        Instant to = from.plus(1, ChronoUnit.HOURS);

        List<Event> events = eventClient.findByStartsAtBetween(from, to);

        for (Event event : events) {
            if (event.getStatus() != EventStatus.PUBLISHED) continue;

            List<Registration> registrations = registrationClient.findByEventId(event.getId());
            for (Registration reg : registrations) {
                if (reg.getStatus() == RegistrationStatus.CONFIRMED) {
                    notificationService.send(/*...*/);
                }
            }
        }
    }
}
```

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

### –ë–ª–æ–∫–∏—Ä—É–µ—Ç

- –ù–µ—Ç

### –ó–∞–≤–∏—Å–∏—Ç –æ—Ç

- [P2-011](./P2-011-registrations-crud.md) –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (—Å–æ–±—ã—Ç–∏—è)
- [P2-012](./P2-012-registrations-qr-code.md) QR-–∫–æ–¥
- [P2-013](./P2-013-notifications-telegram-bot.md) Telegram Bot

## Out of Scope

- –ö–∞—Å—Ç–æ–º–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π
- Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è verification/reset)
- Push notifications
- –ú–∞—Å—Å–æ–≤—ã–µ —Ä–∞—Å—Å—ã–ª–∫–∏ –æ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞

## –ó–∞–º–µ—Ç–∫–∏

- –ü—Ä–∏ –º–∞—Å—Å–æ–≤–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ (–æ—Ç–º–µ–Ω–∞ —Å–æ–±—ã—Ç–∏—è) –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å batch —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π (rate limiting)
- Timezone —Å–æ–±—ã—Ç–∏—è –Ω—É–∂–Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å –ø—Ä–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –¥–∞—Ç—ã
- Markdown –≤ Telegram –æ–≥—Ä–∞–Ω–∏—á–µ–Ω ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –õ–æ–≥–∏ —Ö—Ä–∞–Ω–∏—Ç—å 30 –¥–Ω–µ–π, –∑–∞—Ç–µ–º –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å/—É–¥–∞–ª—è—Ç—å
