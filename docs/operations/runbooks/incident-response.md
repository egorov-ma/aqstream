# Runbook: Incident Response

–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –∏–Ω—Ü–∏–¥–µ–Ω—Ç—ã –≤ AqStream.

## Severity Levels

| Level | –û–ø–∏—Å–∞–Ω–∏–µ | Response Time | –ü—Ä–∏–º–µ—Ä—ã |
|-------|----------|---------------|---------|
| P1 | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π | 15 –º–∏–Ω—É—Ç | –ü–æ–ª–Ω–∞—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å, –ø–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö |
| P2 | –í—ã—Å–æ–∫–∏–π | 1 —á–∞—Å | –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç |
| P3 | –°—Ä–µ–¥–Ω–∏–π | 4 —á–∞—Å–∞ | –ß–∞—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ |
| P4 | –ù–∏–∑–∫–∏–π | 24 —á–∞—Å–∞ | –ö–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã |

## –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏—è

### 1. Detection (–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ)

–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è:
- Alertmanager (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã)
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Grafana dashboards)
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ä–µ–ø–æ—Ä—Ç—ã
- Health checks

### 2. Triage (–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è)

```
‚îå‚îÄ –°–µ—Ä–≤–∏—Å –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω? ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ P1
‚îÇ
‚îú‚îÄ –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –ø–ª–∞—Ç–µ–∂–∏)? ‚îÄ‚îÄ‚îÄ P2
‚îÇ
‚îú‚îÄ –ß–∞—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞—Ç—Ä–æ–Ω—É—Ç–∞? ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄP3
‚îÇ
‚îî‚îÄ –ú–∏–Ω–æ—Ä–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞, workaround —Å—É—â–µ—Å—Ç–≤—É–µ—Ç? ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄP4
```

### 3. Response (–†–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)

#### P1 ‚Äî –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∏–Ω—Ü–∏–¥–µ–Ω—Ç

```bash
# 1. –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —É–≤–µ–¥–æ–º–∏—Ç—å –∫–æ–º–∞–Ω–¥—É
# Slack: #incidents, @channel

# 2. –ù–∞—á–∞—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
docker compose ps
docker compose logs --tail=200

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
curl http://localhost:8080/actuator/health  # Gateway
curl http://localhost:8082/actuator/health  # Event Service
docker compose exec postgres-shared pg_isready -U aqstream
docker compose exec redis redis-cli ping

# 4. –ï—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω–∞ –ø—Ä–∏—á–∏–Ω–∞ ‚Äî –∏—Å–ø—Ä–∞–≤–∏—Ç—å
# –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî rollback –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏
docker compose pull --policy=always
docker compose up -d
```

#### P2 ‚Äî –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

```bash
# 1. –£–≤–µ–¥–æ–º–∏—Ç—å –≤ #incidents

# 2. –ò–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É
# –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–∞–∫–æ–π —Å–µ—Ä–≤–∏—Å –∑–∞—Ç—Ä–æ–Ω—É—Ç

# 3. –°–æ–±—Ä–∞—Ç—å –ª–æ–≥–∏
docker compose logs event-service > incident-logs.txt

# 4. –ü—Ä–∏–º–µ–Ω–∏—Ç—å fix –∏–ª–∏ workaround

# 5. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
```

### 4. Communication (–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è)

**–®–∞–±–ª–æ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –∏–Ω—Ü–∏–¥–µ–Ω—Ç–µ:**

```
üî¥ –ò–ù–¶–ò–î–ï–ù–¢ P1: [–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ]

–°—Ç–∞—Ç—É—Å: –†–∞—Å—Å–ª–µ–¥—É–µ—Ç—Å—è / –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è / Resolved
–ù–∞—á–∞–ª–æ: [–≤—Ä–µ–º—è]
–ó–∞—Ç—Ä–æ–Ω—É—Ç–æ: [—á—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç]
–í–ª–∏—è–Ω–∏–µ: [—Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π/–∫–∞–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏]

–û–±–Ω–æ–≤–ª–µ–Ω–∏—è:
- [–≤—Ä–µ–º—è] [–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ]
```

**–®–∞–±–ª–æ–Ω –ø–æ—Å—Ç–º–æ—Ä—Ç–µ–º–∞:**

```
# Postmortem: [–Ω–∞–∑–≤–∞–Ω–∏–µ]

## Summary
[–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞]

## Timeline
- [–≤—Ä–µ–º—è] –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ
- [–≤—Ä–µ–º—è] –ù–∞—á–∞–ª–æ—Å—å —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
- [–≤—Ä–µ–º—è] –ù–∞–π–¥–µ–Ω–∞ –ø—Ä–∏—á–∏–Ω–∞
- [–≤—Ä–µ–º—è] –ü—Ä–∏–º–µ–Ω—ë–Ω fix
- [–≤—Ä–µ–º—è] Resolved

## Root Cause
[–î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∏—á–∏–Ω—ã]

## Impact
- –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: X –º–∏–Ω—É—Ç
- –ó–∞—Ç—Ä–æ–Ω—É—Ç–æ: X –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ü–æ—Ç–µ—Ä–∏: [–µ—Å–ª–∏ –µ—Å—Ç—å]

## Resolution
[–ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è]

## Action Items
- [ ] [–î–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è]
- [ ] [–£–ª—É—á—à–µ–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞]
```

### 5. Resolution (–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ)

```bash
# 1. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —á—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞
curl http://localhost:8080/actuator/health
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

# 2. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å 30 –º–∏–Ω—É—Ç –Ω–∞ —Ä–µ—Ü–∏–¥–∏–≤

# 3. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞
# Slack: ‚úÖ RESOLVED

# 4. –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å postmortem (–¥–ª—è P1/P2)
```

## –¢–∏–ø–∏—á–Ω—ã–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç—ã

### –°–µ—Ä–≤–∏—Å –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç

```bash
# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
docker compose ps
docker compose logs --tail=100 [service]

# –†–µ—à–µ–Ω–∏–µ
docker compose restart [service]
```

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞

```bash
# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
docker compose exec postgres-shared pg_isready -U aqstream
docker compose logs postgres-shared

# –†–µ—à–µ–Ω–∏–µ
docker compose restart postgres-shared
# –ï—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å disk space
docker system df
```

### Out of Memory

```bash
# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
docker stats
docker compose logs [service] | grep -i "OutOfMemory"

# –†–µ—à–µ–Ω–∏–µ
docker compose restart [service]
# –£–≤–µ–ª–∏—á–∏—Ç—å –ª–∏–º–∏—Ç—ã –ø–∞–º—è—Ç–∏ –≤ docker-compose.yml
```

### High Latency

```bash
# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Grafana dashboard
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å slow queries –≤ –ë–î

# –†–µ—à–µ–Ω–∏–µ
# –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã
# –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã
# –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å
```

### Disk Full

```bash
# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
df -h
docker system df

# –†–µ—à–µ–Ω–∏–µ
docker system prune -f
# –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –ª–æ–≥–∏
# –£–≤–µ–ª–∏—á–∏—Ç—å disk
```

## –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è —ç—Å–∫–∞–ª–∞—Ü–∏–∏

| –†–æ–ª—å | –ö–æ–Ω—Ç–∞–∫—Ç | –ö–æ–≥–¥–∞ |
|------|---------|-------|
| On-call engineer | Slack #incidents | P1-P3 |
| Tech Lead | @techlead | P1-P2 |
| CTO | @cto | P1 (–ø–æ—Å–ª–µ 30 –º–∏–Ω—É—Ç) |

## –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã

| –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç | URL | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------------|-----|------------|
| Grafana | http://localhost:3001 | Dashboards |
| Prometheus | http://localhost:9090 | Metrics |
| Alertmanager | http://localhost:9093 | Alerts |
| Logs | Loki via Grafana | Logs |

## –ß–µ–∫–ª–∏—Å—Ç –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞

- [ ] –ò–Ω—Ü–∏–¥–µ–Ω—Ç –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω (P1-P4)
- [ ] –ö–æ–º–∞–Ω–¥–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∞
- [ ] –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∞
- [ ] –ü—Ä–∏—á–∏–Ω–∞ –Ω–∞–π–¥–µ–Ω–∞
- [ ] Fix/workaround –ø—Ä–∏–º–µ–Ω—ë–Ω
- [ ] –ò–Ω—Ü–∏–¥–µ–Ω—Ç resolved
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ 30 –º–∏–Ω—É—Ç
- [ ] Postmortem –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω (P1/P2)
